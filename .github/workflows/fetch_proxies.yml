name: Fetch and Overwrite tested_proxies.json

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-overwrite:
    runs-on: ubuntu-latest

    steps:
      # ✅ Checkout the public repository
      - name: Checkout public repository
        uses: actions/checkout@v4
        with:
          repository: Ian-Lusule/Proxies-GUI
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # ✅ Download tested_proxies.json from private repo and overwrite
      - name: Fetch tested_proxies.json from private repo
        run: |
          echo "Fetching tested_proxies.json from private repo..."
          curl -H "Authorization: token ${{ secrets.FETCH_PROXIES_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -L "https://api.github.com/repos/Ian-Lusule/Proxies-Scripts/contents/Proxies-GUI-Scripts/tested_proxies.json" \
               -o "assets/tested_proxies.json"
          echo "File successfully fetched and overwritten."

      # ✅ Configure Git
      - name: Configure Git
        run: |
          git config user.name "Ian-Lusule"
          git config user.email "amlusule@gmail.com"

      # ✅ Force add and commit changes (even if file is overwritten)
      - name: Commit and push changes
        run: |
          git add assets/tested_proxies.json
          if git commit -m "Force update tested_proxies.json [auto]"; then
            echo "File committed. Pushing to main branch..."
            git push origin main
          else
            echo "No changes detected, nothing to commit."
          fi
